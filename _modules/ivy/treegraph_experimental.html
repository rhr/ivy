<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ivy.treegraph_experimental &mdash; ivy 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="ivy 0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ivy 0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ivy.treegraph_experimental</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">cPickle</span><span class="o">,</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cmp_to_key</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">ifilter</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cmp_to_key</span>
<span class="kn">import</span> <span class="nn">graph_tool.all</span> <span class="kn">as</span> <span class="nn">gt</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">newick</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tree</span>
<span class="n">newick</span><span class="o">.</span><span class="n">add_label_chars</span><span class="p">(</span><span class="s">&#39;/#&amp;-&#39;</span><span class="p">)</span>

<span class="n">color20</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;#1f77b4&quot;</span><span class="p">,</span> <span class="s">&quot;#aec7e8&quot;</span><span class="p">,</span> <span class="s">&quot;#ff7f0e&quot;</span><span class="p">,</span> <span class="s">&quot;#ffbb78&quot;</span><span class="p">,</span> <span class="s">&quot;#2ca02c&quot;</span><span class="p">,</span> <span class="s">&quot;#98df8a&quot;</span><span class="p">,</span>
           <span class="s">&quot;#d62728&quot;</span><span class="p">,</span> <span class="s">&quot;#ff9896&quot;</span><span class="p">,</span> <span class="s">&quot;#9467bd&quot;</span><span class="p">,</span> <span class="s">&quot;#c5b0d5&quot;</span><span class="p">,</span> <span class="s">&quot;#8c564b&quot;</span><span class="p">,</span> <span class="s">&quot;#c49c94&quot;</span><span class="p">,</span>
           <span class="s">&quot;#e377c2&quot;</span><span class="p">,</span> <span class="s">&quot;#f7b6d2&quot;</span><span class="p">,</span> <span class="s">&quot;#7f7f7f&quot;</span><span class="p">,</span> <span class="s">&quot;#c7c7c7&quot;</span><span class="p">,</span> <span class="s">&quot;#bcbd22&quot;</span><span class="p">,</span> <span class="s">&quot;#dbdb8d&quot;</span><span class="p">,</span>
           <span class="s">&quot;#17becf&quot;</span><span class="p">,</span> <span class="s">&quot;#9edae5&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="get_or_create_vp"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.get_or_create_vp">[docs]</a><span class="k">def</span> <span class="nf">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">p</span>
</div>
<div class="viewcode-block" id="get_or_create_ep"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.get_or_create_ep">[docs]</a><span class="k">def</span> <span class="nf">get_or_create_ep</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ep</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">p</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph">[docs]</a><span class="k">class</span> <span class="nc">TaxonomyGraph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    g is a graph_tool.Graph of vertices (taxa) and edges</span>
<span class="sd">    (parent-&gt;child relationships).</span>

<span class="sd">    vertex properties:</span>
<span class="sd">       name (string)</span>
<span class="sd">       rank (string)</span>
<span class="sd">       taxid (int),</span>
<span class="sd">       istaxon (bool)</span>
<span class="sd">       dubious (bool)</span>
<span class="sd">       incertae sedis (bool),</span>
<span class="sd">       collapsed (bool)</span>
<span class="sd">       snode (int)</span>
<span class="sd">       stree (vector&lt;int&gt;)</span>
<span class="sd">       stem_cdef (vector&lt;int)</span>

<span class="sd">    edge properties:</span>
<span class="sd">       istaxon (bool)</span>
<span class="sd">       stree (vector&lt;int&gt;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="TaxonomyGraph.vertices"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.vertices">[docs]</a>    <span class="k">def</span> <span class="nf">vertices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.vertex"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.vertex">[docs]</a>    <span class="k">def</span> <span class="nf">vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.edges"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.edges">[docs]</a>    <span class="k">def</span> <span class="nf">edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.edge"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.edge">[docs]</a>    <span class="k">def</span> <span class="nf">edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">all_edges</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">all_edges</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.add_edge"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.add_edge">[docs]</a>    <span class="k">def</span> <span class="nf">add_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="TaxonomyGraph.new_vertex_property"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.new_vertex_property">[docs]</a>    <span class="k">def</span> <span class="nf">new_vertex_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.new_edge_property"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.new_edge_property">[docs]</a>    <span class="k">def</span> <span class="nf">new_edge_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.taxid_name"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.taxid_name">[docs]</a>    <span class="k">def</span> <span class="nf">taxid_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxid</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.taxid_dubious"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.taxid_dubious">[docs]</a>    <span class="k">def</span> <span class="nf">taxid_dubious</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxid</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dubious</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.taxid_hindex"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.taxid_hindex">[docs]</a>    <span class="k">def</span> <span class="nf">taxid_hindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxid</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindex</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;no hindex:&#39;</span><span class="p">,</span> <span class="n">taxid</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TaxonomyGraph.new_from_NCBI_taxdump"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.new_from_NCBI_taxdump">[docs]</a>    <span class="k">def</span> <span class="nf">new_from_NCBI_taxdump</span><span class="p">(</span><span class="n">basepath</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        create a TaxonomyGraph containing the NCBI taxonomic hierarchy</span>
<span class="sd">        using files from:</span>

<span class="sd">        ftp://ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdump.tar.gz</span>

<span class="sd">        which are assumed to be unpacked in the directory ``basepath``</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">TaxonomyGraph</span><span class="p">()</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_name</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_rank</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;rank&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_taxid</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;taxid&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_taxonomy</span> <span class="o">=</span> <span class="n">get_or_create_ep</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;istaxon&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;istaxon&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dubious</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;dubious&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;incertae_sedis&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;collapsed&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_strees</span> <span class="o">=</span> <span class="n">get_or_create_ep</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_snode</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;snode&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_strees</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_stem_cdef</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;stem_cdef&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stem_cdef_vertex</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">G</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">())</span>

        <span class="n">node_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;taxid&quot;</span><span class="p">,</span> <span class="s">&quot;parent_taxid&quot;</span><span class="p">,</span> <span class="s">&quot;rank&quot;</span><span class="p">,</span> <span class="s">&quot;embl_code&quot;</span><span class="p">,</span>
                       <span class="s">&quot;division_id&quot;</span><span class="p">,</span> <span class="s">&quot;inherited_div_flag&quot;</span><span class="p">,</span> <span class="s">&quot;genetic_code_id&quot;</span><span class="p">,</span>
                       <span class="s">&quot;inherited_gc_flag&quot;</span><span class="p">,</span> <span class="s">&quot;mt_gc_id&quot;</span><span class="p">,</span> <span class="s">&quot;inherited_mgc_flag&quot;</span><span class="p">,</span>
                       <span class="s">&quot;genbank_hidden_flag&quot;</span><span class="p">,</span> <span class="s">&quot;hidden_subtree_root_flag&quot;</span><span class="p">,</span>
                       <span class="s">&quot;comments&quot;</span><span class="p">]</span>
        <span class="n">name_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;taxid&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;unique_name&quot;</span><span class="p">,</span> <span class="s">&quot;name_class&quot;</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">process_nodes</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...processing nodes&#39;</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)</span> <span class="p">]</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">node_fields</span><span class="p">,</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_flag&#39;</span><span class="p">):</span>
                        <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
                <span class="n">tid</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span>
                <span class="n">n</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="k">if</span> <span class="n">tid</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s">&#39;parent_taxid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">           </span><span class="se">\r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
            <span class="k">print</span>
            <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span>

        <span class="k">def</span> <span class="nf">process_names</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...processing names&#39;</span><span class="p">)</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">synonyms</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">accepted</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)</span> <span class="p">]</span>
                <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">name_fields</span><span class="p">,</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">];</span> <span class="n">uname</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;unique_name&#39;</span><span class="p">];</span> <span class="n">taxid</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span>
                <span class="n">s</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;taxonomic_name&#39;</span>
                <span class="n">s</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;ncbi&#39;</span>
                <span class="k">if</span> <span class="n">uname</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;homonym_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s">&#39;name_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;scientific name&#39;</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">uname</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">):</span>
                    <span class="n">s</span><span class="p">[</span><span class="s">&#39;primary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">accepted</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="p">[</span><span class="s">&#39;primary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">synonyms</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">uname</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">           </span><span class="se">\r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
            <span class="k">print</span>
            <span class="k">return</span> <span class="n">accepted</span><span class="p">,</span> <span class="n">synonyms</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="s">&#39;nodes.dmp&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nodes</span><span class="p">,</span> <span class="n">ptid2ctid</span> <span class="o">=</span> <span class="n">process_nodes</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="s">&#39;names.dmp&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">accepted</span><span class="p">,</span> <span class="n">synonyms</span> <span class="o">=</span> <span class="n">process_names</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">nnodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="n">viter</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">nnodes</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...creating graph vertices&#39;</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tid</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">tid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertex_rank</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;rank&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">accepted</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="c"># !! should deal with unique_name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">tid</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">           </span><span class="se">\r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nnodes</span><span class="o">-</span><span class="n">i</span><span class="p">),</span>
        <span class="k">print</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...creating graph vertices&#39;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptid2ctid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tid</span><span class="p">,</span> <span class="n">child_tids</span> <span class="ow">in</span> <span class="n">ptid2ctid</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ctid</span> <span class="ow">in</span> <span class="n">child_tids</span><span class="p">:</span>
                <span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">ctid</span><span class="p">]</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">cv</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_taxonomy</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">           </span><span class="se">\r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="p">),</span>
        <span class="k">print</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TaxonomyGraph.new_from_graph"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.new_from_graph">[docs]</a>    <span class="k">def</span> <span class="nf">new_from_graph</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">TaxonomyGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_taxid</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_taxonomy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dubious</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;dubious&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;incertae_sedis&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hindex</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;hindex&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">vfilt</span><span class="p">,</span> <span class="n">vinv</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_vertex_filter</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
            <span class="n">taxid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="n">vfilt</span><span class="p">,</span> <span class="n">vinv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_strees</span> <span class="o">=</span> <span class="n">get_or_create_ep</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_snode</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;snode&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_strees</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_stem_cdef</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;stem_cdef&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stem_cdef_vertex</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">())</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
            <span class="n">cdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_stem_cdef</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cdef</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem_cdef_vertex</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cdef</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="n">vfilt</span><span class="p">,</span> <span class="n">vinv</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TaxonomyGraph.load_from_GML"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.load_from_GML">[docs]</a>    <span class="k">def</span> <span class="nf">load_from_GML</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">TaxonomyGraph</span><span class="p">()</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">load_graph</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_taxid</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_taxonomy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dubious</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;dubious&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;incertae_sedis&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hindex</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;hindex&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">edge_strees</span> <span class="o">=</span> <span class="n">get_or_create_ep</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_snode</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;snode&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_strees</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_stem_cdef</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;stem_cdef&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stem_cdef_vertex</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">())</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
            <span class="n">cdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_stem_cdef</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cdef</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem_cdef_vertex</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cdef</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
    <span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># higher taxa that should be removed (nodes collapsed), and their</span>
        <span class="c"># immmediate children flagged incertae sedis and linked back to</span>
        <span class="c"># the parent of collapsed node</span>
        <span class="n">incertae_keywords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;endophyte&#39;</span><span class="p">,</span><span class="s">&#39;scgc&#39;</span><span class="p">,</span><span class="s">&#39;libraries&#39;</span><span class="p">,</span><span class="s">&#39;samples&#39;</span><span class="p">,</span>
            <span class="s">&#39;metagenome&#39;</span><span class="p">,</span><span class="s">&#39;unclassified&#39;</span><span class="p">,</span>
            <span class="s">&#39;other&#39;</span><span class="p">,</span><span class="s">&#39;unidentified&#39;</span><span class="p">,</span><span class="s">&#39;mitosporic&#39;</span><span class="p">,</span><span class="s">&#39;uncultured&#39;</span><span class="p">,</span><span class="s">&#39;incertae&#39;</span><span class="p">,</span>
            <span class="s">&#39;environmental&#39;</span><span class="p">]</span>

        <span class="c"># taxa that are not clades, and should be removed (collapsed) -</span>
        <span class="c"># children linked to parent of collapsed node</span>
        <span class="n">collapse_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;basal &#39;</span><span class="p">,</span><span class="s">&#39;stem &#39;</span><span class="p">,</span><span class="s">&#39;early diverging &#39;</span><span class="p">]</span>

        <span class="c"># higher taxa that should be removed along with all of their children</span>
        <span class="n">remove_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;viroids&#39;</span><span class="p">,</span><span class="s">&#39;virus&#39;</span><span class="p">,</span><span class="s">&#39;viruses&#39;</span><span class="p">,</span><span class="s">&#39;viral&#39;</span><span class="p">,</span><span class="s">&#39;artificial&#39;</span><span class="p">]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;removing vertices that are not real taxa (clades)&#39;</span><span class="p">)</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">rm</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Traverser</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(),</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">remove_keywords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">gt</span><span class="o">.</span><span class="n">dfs_search</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">incertae_keywords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">rm</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">out_neighbours</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">collapse_keywords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
                    <span class="n">rm</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>

        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># assume root == vertex 0</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="p">[</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span>
                  <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outer</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">rm</span><span class="p">[</span><span class="n">p</span><span class="p">]:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_taxonomy</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&#39;done&#39;</span>

        <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">):</span> <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">_index_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        create a vertex property map with hierarchical (left, right)</span>
<span class="sd">        indices</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;indexing graph (left-right and depth values)&#39;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># root</span>
        <span class="n">hindex</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;hindex&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;depth&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span>
        <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">dep</span><span class="p">):</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">out_degree</span><span class="p">():</span>
                <span class="n">l0</span> <span class="o">=</span> <span class="n">left</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">out_neighbours</span><span class="p">():</span>
                    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">traverse</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">left</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">r</span>
                <span class="n">lr</span> <span class="o">=</span> <span class="p">(</span><span class="n">l0</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lr</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">left</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">hindex</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>
            <span class="c">## print g.vertex_name[p], lr</span>
            <span class="k">print</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hindex</span> <span class="o">=</span> <span class="n">hindex</span>
        <span class="n">traverse</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...done&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="TaxonomyGraph.map_stree"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.map_stree">[docs]</a>    <span class="k">def</span> <span class="nf">map_stree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Traverse the tree `root` and assign taxon ids (taxids) to its</span>
<span class="sd">        nodes, as well as other information, e.g. whether a leaf is</span>
<span class="sd">        &#39;incertae sedis&#39; within a higher taxon, and how nodes conflict</span>
<span class="sd">        with the taxonomy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&#39;mapping&#39;</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="n">stree</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">children</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">taxid</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">n</span><span class="o">.</span><span class="n">taxids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c"># taxa represented by the node</span>
            <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">n</span><span class="o">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># vertex in G</span>
            <span class="n">n</span><span class="o">.</span><span class="n">taxid_conflicts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c"># taxa in descendants that are not</span>
                                      <span class="c"># monophyletic</span>
            <span class="n">n</span><span class="o">.</span><span class="n">taxid_mrcas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c"># taxa whose mrca in the tree maps to the node</span>
            <span class="n">n</span><span class="o">.</span><span class="n">leaf_rootpath</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">n</span><span class="o">.</span><span class="n">nleaves</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n</span><span class="o">.</span><span class="n">leaf_is_higher_taxon</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">n</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">lvs</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">leaves</span><span class="p">()</span>
        <span class="n">leafcounts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;!!! [</span><span class="si">%s</span><span class="s">] no taxid:&#39;</span> <span class="o">%</span> <span class="n">root</span><span class="o">.</span><span class="n">stree</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">snode_id</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">label</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;!!! [</span><span class="si">%s</span><span class="s">] taxid not in taxonomy:&#39;</span> <span class="o">%</span> \
                      <span class="n">root</span><span class="o">.</span><span class="n">stree</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">snode_id</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">label</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">leafcounts</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">]</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">v</span><span class="p">]</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="o">=</span> <span class="n">taxid_rootpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lf</span><span class="o">.</span><span class="n">rootpath</span><span class="p">():</span> <span class="n">n</span><span class="o">.</span><span class="n">nleaves</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">multileaves</span> <span class="o">=</span> <span class="p">[</span> <span class="n">taxid</span> <span class="k">for</span> <span class="n">taxid</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">leafcounts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">]</span>
        <span class="n">root_mrca</span> <span class="o">=</span> <span class="n">rootpath_mrca</span><span class="p">([</span> <span class="n">x</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lvs</span>
                                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="p">])</span>
        <span class="n">root</span><span class="o">.</span><span class="n">taxid</span> <span class="o">=</span> <span class="n">root_mrca</span>
        <span class="k">print</span> <span class="s">&#39;root is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_name</span><span class="p">(</span><span class="n">root_mrca</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span>
            <span class="k">if</span> <span class="n">rp</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">root_mrca</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">:</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">in</span> <span class="n">multileaves</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;!!! multiple taxid: </span><span class="si">%s</span><span class="s"> at lf </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">,</span> <span class="n">lf</span><span class="p">)</span>
                    <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">all_taxids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span> <span class="n">all_taxids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">taxid_rootpath</span><span class="p">)</span>
        <span class="n">subgraph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_subgraph</span><span class="p">(</span><span class="n">all_taxids</span><span class="p">)</span>
        <span class="n">all_taxids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">taxid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span>
                <span class="n">vtx</span> <span class="o">=</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">vtx</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c"># higher taxon at leaf</span>
                    <span class="k">print</span> <span class="s">&#39;!!! higher taxon </span><span class="si">%s</span><span class="s"> at lf </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">lf</span><span class="o">.</span><span class="n">leaf_is_higher_taxon</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">def</span> <span class="nf">taxid_cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            taxids: if t1 is nested in t2, return t1 before t2</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">t1</span> <span class="o">==</span> <span class="n">t2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t2</span><span class="p">]</span>
            <span class="n">l1</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindex</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span>
            <span class="n">l2</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindex</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&gt;</span> <span class="n">l2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r1</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># t1 nested in t2</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&lt;</span> <span class="n">l2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r1</span> <span class="o">&gt;</span> <span class="n">r2</span><span class="p">):</span> <span class="k">return</span> <span class="mi">1</span> <span class="c"># t2 nested in t1</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>

        <span class="n">taxid_key</span> <span class="o">=</span> <span class="n">cmp_to_key</span><span class="p">(</span><span class="n">taxid_cmp</span><span class="p">)</span>

        <span class="n">conflicts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">con2mrca</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">taxid</span> <span class="ow">in</span> <span class="n">all_taxids</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            find the mrca node of each taxid in the tree, and determine if</span>
<span class="sd">            it is monophyletic, taking into account tips that are incertae</span>
<span class="sd">            sedis and/or unmapped</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">nxt</span><span class="p">,</span> <span class="n">bck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_hindex</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">[</span> <span class="n">lf</span> <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span> <span class="k">if</span> <span class="n">taxid</span> <span class="ow">in</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">mrca</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">taxid_mrcas</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
            <span class="n">ismono</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">leaves</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">leaf_is_higher_taxon</span><span class="p">:</span>
                                <span class="c"># is taxid nested within lf.taxid?</span>
                                <span class="n">vnext</span><span class="p">,</span> <span class="n">vback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_hindex</span><span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nxt</span> <span class="o">&gt;</span> <span class="n">vnext</span> <span class="ow">and</span> <span class="n">bck</span> <span class="o">&lt;</span> <span class="n">vback</span><span class="p">):</span> <span class="c"># no</span>
                                    <span class="n">conflicts</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                                    <span class="n">n</span><span class="o">.</span><span class="n">taxid_conflicts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
                                    <span class="n">con2mrca</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                                    <span class="n">ismono</span> <span class="o">=</span> <span class="bp">False</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">conflicts</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                                <span class="n">n</span><span class="o">.</span><span class="n">taxid_conflicts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
                                <span class="n">con2mrca</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                                <span class="n">ismono</span> <span class="o">=</span> <span class="bp">False</span>
                                <span class="k">break</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># is the parent taxon of lf.taxid an ancestor of taxid?</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">p</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span> <span class="c"># lf is mapped to root!</span>
                                <span class="k">continue</span>
                            <span class="n">ptax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">taxid_cmp</span><span class="p">(</span><span class="n">ptax</span><span class="p">,</span> <span class="n">taxid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># taxid is nested in ptax</span>
                                <span class="k">continue</span>
                            <span class="n">conflicts</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                            <span class="n">n</span><span class="o">.</span><span class="n">taxid_conflicts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
                            <span class="n">con2mrca</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                            <span class="n">ismono</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ismono</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">taxids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">taxid_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">taxids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">mrca</span> <span class="o">=</span> <span class="n">con2mrca</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lf</span><span class="o">.</span><span class="n">rootpath</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">mrca</span><span class="p">:</span> <span class="k">break</span>
                    <span class="n">n</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">postiter</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],)</span>
                <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
            <span class="k">elif</span> <span class="n">n</span><span class="o">.</span><span class="n">taxid</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
                    <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxid</span><span class="p">,)</span>
                    <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxid</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
                    <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">n</span><span class="o">.</span><span class="n">isleaf</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
                <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxid_mrcas</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">children</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">stem_cdef</span><span class="p">)</span>
                <span class="n">cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">stem_discard</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">crown_discard</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">t1</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">taxid_cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">stem_discard</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                            <span class="n">crown_discard</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">stem_discard</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
                            <span class="n">crown_discard</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cdef</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stem_discard</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cdef</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">crown_discard</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span><span class="p">))</span>
            <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">postiter</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">parent</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span><span class="o">==</span><span class="n">n</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">stem_cdef</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>

        <span class="n">root</span><span class="o">.</span><span class="n">conflicts</span> <span class="o">=</span> <span class="n">conflicts</span>
        <span class="n">root</span><span class="o">.</span><span class="n">con2mrca</span> <span class="o">=</span> <span class="n">con2mrca</span>
        <span class="k">return</span> <span class="n">root</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.taxid_subgraph"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.taxid_subgraph">[docs]</a>    <span class="k">def</span> <span class="nf">taxid_subgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create a new TaxonomyGraph based on a filtered view of self.g</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="n">vfilt</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">taxids</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">vfilt</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">gv</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">vfilt</span><span class="o">=</span><span class="n">vfilt</span><span class="p">,</span> <span class="n">efilt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_taxonomy</span><span class="p">)</span>
        <span class="n">gv</span><span class="o">.</span><span class="n">vfilt</span> <span class="o">=</span> <span class="n">vfilt</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gv</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="ow">in</span> <span class="n">taxids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gv</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;!!! root? vertex&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_from_graph</span><span class="p">(</span><span class="n">gv</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.taxid_new_subgraph"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.taxid_new_subgraph">[docs]</a>    <span class="k">def</span> <span class="nf">taxid_new_subgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create a new TaxonomyGraph based on a copy of self.g</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newg</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">newp</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value_type</span><span class="p">())</span>
            <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">newp</span>
        <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">ep</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">newp</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value_type</span><span class="p">())</span>
            <span class="n">newg</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">newp</span>
        <span class="n">ovi2nvi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">taxids</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">newv</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">()</span>
            <span class="n">ovi2nvi</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">newv</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="n">pname</span><span class="p">][</span><span class="n">newv</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">taxids</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">newv</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">ovi2nvi</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">in_edges</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="p">())</span> <span class="ow">in</span> <span class="n">ovi2nvi</span><span class="p">:</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">ovi2nvi</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="p">())])</span>
                    <span class="n">newe</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">newv</span><span class="p">)</span>
                    <span class="n">newg</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">][</span><span class="n">newe</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">newg</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">tid</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&#39;!!! root? vertex&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">tid</span><span class="p">,</span> <span class="n">newg</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="c">#assert len(r)==1, r</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_from_graph</span><span class="p">(</span><span class="n">newg</span><span class="p">)</span>
        <span class="n">sg</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sg</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.merge_stree"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.merge_stree">[docs]</a>    <span class="k">def</span> <span class="nf">merge_stree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">stree</span><span class="p">,</span> <span class="n">verts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="k">if</span> <span class="n">verts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">verts</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">edges</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">taxids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span>
                <span class="c"># node represents 1+ taxa</span>
                <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">taxids</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">node</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">strees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span> <span class="k">break</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                    <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">strees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">p</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">or</span> <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                    <span class="c">## if v == p:</span>
                    <span class="c">##     print &#39;!! merge_stree&#39;, node.snode_id, v</span>
                    <span class="c">##     loops.append((root, e))</span>
                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">strees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_strees</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>
                    <span class="c">## G.edge_stree[e] = stree</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">taxid</span><span class="p">]</span>
                <span class="n">node</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">strees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span> <span class="c"># node is a clade</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem_cdef_vertex</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">stem_cdef</span><span class="p">]</span>
                <span class="n">node</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertex_stem_cdef</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">stem_cdef</span>
                <span class="n">strees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">()</span>
                <span class="n">node</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">strees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">v</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">taxids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">taxids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">or</span> <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;!! LOOP:&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">snode_id</span><span class="p">,</span> <span class="n">v</span>
                    <span class="c">## loops.append((node, e))</span>
                <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">strees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_strees</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">leaves</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="ow">and</span> <span class="n">lf</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">label</span>

        <span class="k">return</span> <span class="n">verts</span><span class="p">,</span> <span class="n">edges</span>
</div>
<div class="viewcode-block" id="TaxonomyGraph.view"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.TaxonomyGraph.view">[docs]</a>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vfilt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">efilt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_from_graph</span><span class="p">(</span><span class="n">gt</span><span class="o">.</span><span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">vfilt</span><span class="o">=</span><span class="n">vfilt</span><span class="p">,</span> <span class="n">efilt</span><span class="o">=</span><span class="n">efilt</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">]</span>
        <span class="c">## assert len(r)==1</span>
        <span class="k">assert</span> <span class="n">r</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;!!! disconnected view&#39;</span>
        <span class="n">view</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">view</span>
</div></div>
<div class="viewcode-block" id="Traverser"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.Traverser">[docs]</a><span class="k">class</span> <span class="nc">Traverser</span><span class="p">(</span><span class="n">gt</span><span class="o">.</span><span class="n">DFSVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># function to call on each vertex, preorder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pre</span><span class="p">:</span> <span class="n">pre</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">pre</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span> <span class="n">post</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">post</span> <span class="c"># postorder</span>

<div class="viewcode-block" id="Traverser.discover_vertex"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.Traverser.discover_vertex">[docs]</a>    <span class="k">def</span> <span class="nf">discover_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Traverser.finish_vertex"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.Traverser.finish_vertex">[docs]</a>    <span class="k">def</span> <span class="nf">finish_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="taxid_cmp"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.taxid_cmp">[docs]</a><span class="k">def</span> <span class="nf">taxid_cmp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    taxids: if t1 is nested in t2, return t1 before t2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t1</span> <span class="o">==</span> <span class="n">t2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t2</span><span class="p">]</span>
    <span class="n">l1</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">hindex</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span>
    <span class="n">l2</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">hindex</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&gt;</span> <span class="n">l2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r1</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># t1 nested in t2</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&lt;</span> <span class="n">l2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r1</span> <span class="o">&gt;</span> <span class="n">r2</span><span class="p">):</span> <span class="k">return</span> <span class="mi">1</span> <span class="c"># t2 nested in t1</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
</div>
<span class="n">taxid_key</span> <span class="o">=</span> <span class="n">cmp_to_key</span><span class="p">(</span><span class="n">taxid_cmp</span><span class="p">)</span>

<div class="viewcode-block" id="index_graph"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.index_graph">[docs]</a><span class="k">def</span> <span class="nf">index_graph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">reindex</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    create a vertex property map with hierarchical (left, right)</span>
<span class="sd">    indices</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;indexing graph (left-right and depth values)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;hindex&#39;</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span> <span class="ow">and</span> <span class="s">&#39;depth&#39;</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reindex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">g</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># root</span>
    <span class="n">hindex</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;hindex&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;depth&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span>
    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">dep</span><span class="p">):</span>
        <span class="n">depth</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">out_degree</span><span class="p">():</span>
            <span class="n">l0</span> <span class="o">=</span> <span class="n">left</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">out_neighbours</span><span class="p">():</span>
                <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">traverse</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">left</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="p">(</span><span class="n">l0</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">left</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hindex</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>
        <span class="c">## print g.vertex_name[p], lr</span>
        <span class="k">print</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">lr</span>
    <span class="n">g</span><span class="o">.</span><span class="n">hindex</span> <span class="o">=</span> <span class="n">hindex</span>
    <span class="n">traverse</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...done&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="create_ncbi_taxonomy_graph"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.create_ncbi_taxonomy_graph">[docs]</a><span class="k">def</span> <span class="nf">create_ncbi_taxonomy_graph</span><span class="p">(</span><span class="n">basepath</span><span class="o">=</span><span class="s">&#39;ncbi&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    create a graph containing the NCBI taxonomic hierarchy using files from:</span>

<span class="sd">    ftp://ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdump.tar.gz</span>

<span class="sd">    which are assumed to be unpacked in the directory ``basepath``</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">node_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;taxid&quot;</span><span class="p">,</span> <span class="s">&quot;parent_taxid&quot;</span><span class="p">,</span> <span class="s">&quot;rank&quot;</span><span class="p">,</span> <span class="s">&quot;embl_code&quot;</span><span class="p">,</span> <span class="s">&quot;division_id&quot;</span><span class="p">,</span>
                   <span class="s">&quot;inherited_div_flag&quot;</span><span class="p">,</span> <span class="s">&quot;genetic_code_id&quot;</span><span class="p">,</span> <span class="s">&quot;inherited_gc_flag&quot;</span><span class="p">,</span>
                   <span class="s">&quot;mt_gc_id&quot;</span><span class="p">,</span> <span class="s">&quot;inherited_mgc_flag&quot;</span><span class="p">,</span> <span class="s">&quot;genbank_hidden_flag&quot;</span><span class="p">,</span>
                   <span class="s">&quot;hidden_subtree_root_flag&quot;</span><span class="p">,</span> <span class="s">&quot;comments&quot;</span><span class="p">]</span>
    <span class="n">name_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;taxid&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;unique_name&quot;</span><span class="p">,</span> <span class="s">&quot;name_class&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">process_nodes</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...processing nodes&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">node_fields</span><span class="p">,</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_flag&#39;</span><span class="p">):</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span>
            <span class="n">n</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">tid</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s">&#39;parent_taxid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">           </span><span class="se">\r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
        <span class="k">print</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">process_names</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...processing names&#39;</span><span class="p">)</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">synonyms</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">name_fields</span><span class="p">,</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">];</span> <span class="n">uname</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;unique_name&#39;</span><span class="p">];</span> <span class="n">taxid</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span>
            <span class="n">s</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;taxonomic_name&#39;</span>
            <span class="n">s</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;ncbi&#39;</span>
            <span class="k">if</span> <span class="n">uname</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;homonym_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;name_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;scientific name&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">uname</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">s</span><span class="p">[</span><span class="s">&#39;primary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">accepted</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="p">[</span><span class="s">&#39;primary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">synonyms</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">uname</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">           </span><span class="se">\r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
        <span class="k">print</span>
        <span class="k">return</span> <span class="n">accepted</span><span class="p">,</span> <span class="n">synonyms</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="s">&#39;nodes.dmp&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">nodes</span><span class="p">,</span> <span class="n">ptid2ctid</span> <span class="o">=</span> <span class="n">process_nodes</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="s">&#39;names.dmp&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">accepted</span><span class="p">,</span> <span class="n">synonyms</span> <span class="o">=</span> <span class="n">process_names</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">G</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">vertex_name</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">vertex_rank</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;rank&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">vertex_taxid</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;taxid&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">edge_in_taxonomy</span> <span class="o">=</span> <span class="n">get_or_create_ep</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;istaxon&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;istaxon&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">dubious</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;dubious&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;incertae_sedis&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;collapsed&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">nnodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">viter</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">nnodes</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...creating graph vertices&#39;</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">tid</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">G</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">tid</span>
        <span class="n">G</span><span class="o">.</span><span class="n">vertex_rank</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;rank&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">accepted</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="c"># !! should deal with unique_name</span>
            <span class="n">G</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">tid</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">           </span><span class="se">\r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nnodes</span><span class="o">-</span><span class="n">i</span><span class="p">),</span>
    <span class="k">print</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;...creating graph vertices&#39;</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptid2ctid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tid</span><span class="p">,</span> <span class="n">child_tids</span> <span class="ow">in</span> <span class="n">ptid2ctid</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ctid</span> <span class="ow">in</span> <span class="n">child_tids</span><span class="p">:</span>
            <span class="n">cv</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">ctid</span><span class="p">]</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">cv</span><span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">edge_in_taxonomy</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">           </span><span class="se">\r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="p">),</span>
    <span class="k">print</span>

    <span class="n">G</span><span class="o">.</span><span class="n">edge_strees</span> <span class="o">=</span> <span class="n">get_or_create_ep</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">vertex_snode</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;snode&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">vertex_strees</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">vertex_stem_cdef</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s">&#39;stem_cdef&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">stem_cdef_vertex</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">G</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">())</span>

    <span class="n">_filter</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">index_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">_attach_funcs</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

    <span class="n">G</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">G</span>

<span class="c">## def _create_ott_taxonomy_graph(version=&#39;2.1&#39;):</span>
<span class="c">##     g = gt.Graph()</span>
<span class="c">##     g.vertex_name = get_or_create_vp(g, &#39;name&#39;, &#39;string&#39;)</span>
<span class="c">##     g.vertex_taxid = get_or_create_vp(g, &#39;taxid&#39;, &#39;int&#39;)</span>
<span class="c">##     g.edge_in_taxonomy = get_or_create_ep(g, &#39;istaxon&#39;, &#39;bool&#39;)</span>
<span class="c">##     g.vertex_in_taxonomy = get_or_create_vp(g, &#39;istaxon&#39;, &#39;bool&#39;)</span>
<span class="c">##     g.dubious = get_or_create_vp(g, &#39;dubious&#39;, &#39;bool&#39;)</span>
<span class="c">##     g.incertae_sedis = get_or_create_vp(g, &#39;incertae_sedis&#39;, &#39;bool&#39;)</span>
<span class="c">##     g.collapsed = get_or_create_vp(g, &#39;collapsed&#39;, &#39;bool&#39;)</span>
<span class="c">##     g.taxid_vertex = {}</span>

<span class="c">##     #N = 2644684</span>
<span class="c">##     taxid2vid = {}</span>
<span class="c">##     data = []</span>
<span class="c">##     n = 0</span>
<span class="c">##     split = lambda s: (</span>
<span class="c">##         [ x.strip() or None for x in s.split(&#39;|&#39;)][:-1] if s[-2]==&#39;\t&#39;</span>
<span class="c">##         else [ x.strip() or None for x in s.split(&#39;|&#39;)]</span>
<span class="c">##     )</span>
<span class="c">##     with open(&#39;ott-%s/taxonomy&#39; % version) as f:</span>
<span class="c">##         f.readline()</span>
<span class="c">##         for v in map(split, f):</span>
<span class="c">##             for i in 0,1: v[i] = int(v[i] or 0)</span>
<span class="c">##             taxid = v[0]</span>
<span class="c">##             taxid2vid[taxid] = n</span>
<span class="c">##             data.append(v)</span>
<span class="c">##             print n, &#39;\r&#39;,</span>
<span class="c">##             n += 1</span>
<span class="c">##         print &#39;done&#39;</span>

<span class="c">##     g.add_vertex(n)</span>
<span class="c">##     for i, row in enumerate(data):</span>
<span class="c">##         taxid = row[0]</span>
<span class="c">##         parent = row[1]</span>
<span class="c">##         name = row[2]</span>
<span class="c">##         v = g.vertex(i)</span>
<span class="c">##         g.vertex_in_taxonomy[v] = 1</span>
<span class="c">##         g.vertex_taxid[v] = taxid</span>
<span class="c">##         g.vertex_name[v] = name</span>
<span class="c">##         g.taxid_vertex[taxid] = v</span>

<span class="c">##         if row[-1] and &#39;D&#39; in row[-1]: g.dubious[v] = 1</span>

<span class="c">##         if parent:</span>
<span class="c">##             pv = g.vertex(taxid2vid[parent])</span>
<span class="c">##             e = g.add_edge(pv, v)</span>
<span class="c">##             g.edge_in_taxonomy[e] = 1</span>
<span class="c">##         print i, &#39;\r&#39;,</span>
<span class="c">##     print &#39;done&#39;</span>

<span class="c">##     _filter(g)</span>
<span class="c">##     index_graph(g)</span>
<span class="c">##     _attach_funcs(g)</span>

<span class="c">##     g.root = g.vertex(0)</span>
<span class="c">##     return g</span>
</div>
<div class="viewcode-block" id="graph_json"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.graph_json">[docs]</a><span class="k">def</span> <span class="nf">graph_json</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ewidth</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">vcolor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vsize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vtext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">simplejson</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">pos</span><span class="p">:</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span> <span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="p">])</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span> <span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="p">])</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span> <span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmin</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymin</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()):</span>
        <span class="n">idx</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">taxid</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_name</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span> <span class="k">if</span> <span class="n">taxid</span> <span class="k">else</span> <span class="s">&#39;node</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">isleaf</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">isleaf</span><span class="o">=</span><span class="n">isleaf</span><span class="p">,</span> <span class="n">strees</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">taxid</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxid</span>
        <span class="k">if</span> <span class="n">dist</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">and</span> <span class="n">pos</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">d</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">d</span><span class="p">[</span><span class="s">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">vcolor</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcolor</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vsize</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsize</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vtext</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vtext</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&#39;altlabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="p">())]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">target</span><span class="p">())]</span>
        <span class="n">strees</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">edge_strees</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">strees</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">strees</span><span class="p">),</span>
                 <span class="n">taxedge</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">edge_in_taxonomy</span><span class="p">[</span><span class="n">e</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">ecolor</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecolor</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ewidth</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ewidth</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">simplejson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">),</span> <span class="n">fp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="graph_view"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.graph_view">[docs]</a><span class="k">def</span> <span class="nf">graph_view</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">vfilt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">efilt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">view</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">vfilt</span><span class="o">=</span><span class="n">vfilt</span><span class="p">,</span> <span class="n">efilt</span><span class="o">=</span><span class="n">efilt</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">vertex_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_name</span>
    <span class="n">view</span><span class="o">.</span><span class="n">vertex_taxid</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_taxid</span>
    <span class="n">view</span><span class="o">.</span><span class="n">edge_in_taxonomy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">edge_in_taxonomy</span>
    <span class="n">view</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span>
    <span class="n">view</span><span class="o">.</span><span class="n">dubious</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dubious</span>
    <span class="n">view</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">incertae_sedis</span>
    <span class="n">view</span><span class="o">.</span><span class="n">taxid_vertex</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span>
    <span class="n">view</span><span class="o">.</span><span class="n">hindex</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">hindex</span>
    <span class="n">view</span><span class="o">.</span><span class="n">edge_strees</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">edge_strees</span>
    <span class="n">view</span><span class="o">.</span><span class="n">vertex_snode</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_snode</span>
    <span class="n">view</span><span class="o">.</span><span class="n">vertex_strees</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_strees</span>
    <span class="n">view</span><span class="o">.</span><span class="n">vertex_stem_cdef</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_stem_cdef</span>
    <span class="n">view</span><span class="o">.</span><span class="n">stem_cdef_vertex</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">stem_cdef_vertex</span>
    <span class="n">_attach_funcs</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">]</span>
    <span class="c">## assert len(r)==1</span>
    <span class="k">assert</span> <span class="n">r</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;!!! disconnected view&#39;</span>
    <span class="n">view</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">view</span>
</div>
<span class="k">def</span> <span class="nf">_attach_funcs</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">taxid_name</span><span class="p">(</span><span class="n">taxid</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">taxid_name</span> <span class="o">=</span> <span class="n">taxid_name</span>

    <span class="k">def</span> <span class="nf">taxid_dubious</span><span class="p">(</span><span class="n">taxid</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">dubious</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">taxid_dubious</span> <span class="o">=</span> <span class="n">taxid_dubious</span>

    <span class="k">def</span> <span class="nf">taxid_hindex</span><span class="p">(</span><span class="n">taxid</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">hindex</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;no hindex:&#39;</span><span class="p">,</span> <span class="n">taxid</span>
    <span class="n">g</span><span class="o">.</span><span class="n">taxid_hindex</span> <span class="o">=</span> <span class="n">taxid_hindex</span>


<div class="viewcode-block" id="load_taxonomy_graph"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.load_taxonomy_graph">[docs]</a><span class="k">def</span> <span class="nf">load_taxonomy_graph</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">load_graph</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">vertex_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">vertex_taxid</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">edge_in_taxonomy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">dubious</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;dubious&#39;</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;incertae_sedis&#39;</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">hindex</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;hindex&#39;</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">edge_strees</span> <span class="o">=</span> <span class="n">get_or_create_ep</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">vertex_snode</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;snode&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">vertex_strees</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;stree&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">vertex_stem_cdef</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;stem_cdef&#39;</span><span class="p">,</span> <span class="s">&#39;vector&lt;int&gt;&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">stem_cdef_vertex</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">())</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="n">cdef</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_stem_cdef</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cdef</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">stem_cdef_vertex</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cdef</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">_attach_funcs</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c">## r = [ x for x in g.vertices() if x.in_degree()==0 ]</span>
    <span class="c">## assert len(r)==1</span>
    <span class="c">## g.root = r[0]</span>
    <span class="c">## p = g.vp.get(&#39;collapsed&#39;)</span>
    <span class="c">## if p and sum(p.a):</span>
    <span class="c">##     g = graph_view(g, vfilt=p)</span>
    <span class="k">return</span> <span class="n">g</span>
</div>
<div class="viewcode-block" id="taxid_subgraph"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.taxid_subgraph">[docs]</a><span class="k">def</span> <span class="nf">taxid_subgraph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">taxids</span><span class="p">):</span>
    <span class="n">vfilt</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">taxids</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="n">vfilt</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">sg</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">vfilt</span><span class="o">=</span><span class="n">vfilt</span><span class="p">,</span> <span class="n">efilt</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">edge_in_taxonomy</span><span class="p">)</span>
    <span class="n">sg</span><span class="o">.</span><span class="n">vfilt</span> <span class="o">=</span> <span class="n">vfilt</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sg</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="ow">in</span> <span class="n">taxids</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sg</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;!!! root? vertex&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
    <span class="n">sg</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sg</span><span class="o">.</span><span class="n">taxid_vertex</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sg</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="n">taxid</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">sg</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxid</span>
    <span class="n">_attach_funcs</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sg</span>
</div>
<div class="viewcode-block" id="taxid_new_subgraph"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.taxid_new_subgraph">[docs]</a><span class="k">def</span> <span class="nf">taxid_new_subgraph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">taxids</span><span class="p">):</span>
    <span class="n">newg</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">newp</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value_type</span><span class="p">())</span>
        <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">newp</span>
    <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">ep</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">newp</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value_type</span><span class="p">())</span>
        <span class="n">newg</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">newp</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">vertex_name</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">vertex_taxid</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">edge_in_taxonomy</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">dubious</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;dubious&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;incertae_sedis&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">hindex</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;hindex&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">edge_strees</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&#39;stree&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">vertex_snode</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;snode&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">vertex_strees</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;stree&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">vertex_stem_cdef</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;stem_cdef&#39;</span><span class="p">]</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">stem_cdef_vertex</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">newg</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">())</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">taxid_vertex</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ovi2nvi</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">taxids</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="n">newv</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">()</span>
        <span class="n">ovi2nvi</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">newv</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">newg</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="n">pname</span><span class="p">][</span><span class="n">newv</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">newg</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">newv</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">taxids</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="n">newv</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">ovi2nvi</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">in_edges</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="p">())</span> <span class="ow">in</span> <span class="n">ovi2nvi</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">ovi2nvi</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="p">())])</span>
                <span class="n">newe</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">newv</span><span class="p">)</span>
                <span class="n">newg</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&#39;istaxon&#39;</span><span class="p">][</span><span class="n">newe</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">break</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">newg</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">newg</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">print</span> <span class="s">&#39;!!! root? vertex&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">tid</span><span class="p">,</span> <span class="n">newg</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="c">#assert len(r)==1, r</span>
    <span class="n">newg</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_attach_funcs</span><span class="p">(</span><span class="n">newg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newg</span>
</div>
<div class="viewcode-block" id="taxonomy_subtree"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.taxonomy_subtree">[docs]</a><span class="k">def</span> <span class="nf">taxonomy_subtree</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">g</span><span class="o">.</span><span class="n">vertex_in_taxonomy</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;istaxon&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">edge_in_taxonomy</span> <span class="o">=</span> <span class="n">get_or_create_ep</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;istaxon&#39;</span><span class="p">,</span> <span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">vertex_taxid</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;taxid&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">vertex_name</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">dubious</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;dubious&#39;</span><span class="p">,</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="n">get_or_create_vp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;incertae_sedis&#39;</span><span class="p">,</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">GP</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">vp</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span> <span class="p">]</span>
    <span class="k">def</span> <span class="nf">copy_vertex_properties</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">gv</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">pmap</span> <span class="ow">in</span> <span class="n">GP</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="n">pname</span><span class="p">][</span><span class="n">gv</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmap</span><span class="p">[</span><span class="n">Gv</span><span class="p">]</span>

        <span class="n">taxid</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">Gv</span><span class="p">]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">gv</span>

    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">()</span>
        <span class="n">copy_vertex_properties</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">edge_in_taxonomy</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nx</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">out_neighbours</span><span class="p">():</span>
            <span class="n">traverse</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">()</span>
    <span class="n">copy_vertex_properties</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">out_neighbours</span><span class="p">():</span>
        <span class="n">traverse</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="n">index_graph</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">_attach_funcs</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span>
    </div>
<div class="viewcode-block" id="graph2sqlite"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.graph2sqlite">[docs]</a><span class="k">def</span> <span class="nf">graph2sqlite</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sqlite3</span> <span class="kn">as</span> <span class="nn">db</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
    <span class="n">create</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;create table if not exists name ( &#39;</span>
                    <span class="s">&#39;uid integer primary key, &#39;</span>
                    <span class="s">&#39;parent_uid integer, &#39;</span>
                    <span class="s">&#39;name text not null, &#39;</span>
                    <span class="s">&#39;depth integer not null, &#39;</span>
                    <span class="s">&#39;rank text, &#39;</span>
                    <span class="s">&#39;next integer not null, &#39;</span>
                    <span class="s">&#39;back integer not null &#39;</span>
                    <span class="s">&#39;)&#39;</span><span class="p">)</span>

    <span class="n">vertex_taxid</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;taxid&#39;</span><span class="p">]</span>
    <span class="n">vertex_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">vertex_rank</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;rank&#39;</span><span class="p">]</span>
    <span class="n">vertex_depth</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;depth&#39;</span><span class="p">]</span>
    <span class="n">hindex</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&#39;hindex&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="n">taxid</span> <span class="o">=</span> <span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">parent_taxid</span> <span class="o">=</span> <span class="n">vertex_taxid</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_taxid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">vertex_name</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">vertex_rank</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">vertex_depth</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">nxt</span><span class="p">,</span> <span class="n">bck</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">hindex</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">taxid</span><span class="p">,</span> <span class="n">parent_taxid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">nxt</span><span class="p">,</span> <span class="n">bck</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;insert into name &#39;</span>
                    <span class="s">&#39;(uid, parent_uid, name, depth, rank, next, back) &#39;</span>
                    <span class="s">&#39;values (?, ?, ?, ?, ?, ?, ?);&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">print</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="k">print</span> <span class="s">&#39;done&#39;</span>
    
    <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;create index nextback on name (next, back)&#39;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;create index parent on name (parent_uid)&#39;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;create index nameidx on name (name)&#39;</span><span class="p">)</span>

    <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="taxid_rootpath"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.taxid_rootpath">[docs]</a><span class="k">def</span> <span class="nf">taxid_rootpath</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">taxid</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">taxid</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">v</span><span class="o">.</span><span class="n">in_degree</span><span class="p">():</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="ow">and</span> <span class="n">tid</span> <span class="o">==</span> <span class="n">stop</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">return</span> <span class="n">x</span>
</div>
<div class="viewcode-block" id="rootpath_mrca"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.rootpath_mrca">[docs]</a><span class="k">def</span> <span class="nf">rootpath_mrca</span><span class="p">(</span><span class="n">rootpaths</span><span class="p">,</span> <span class="n">i</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rootpaths</span> <span class="p">])</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rootpaths</span> <span class="p">])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="map_stree"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.map_stree">[docs]</a><span class="k">def</span> <span class="nf">map_stree</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;mapping&#39;</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="n">stree</span>
    <span class="c">## root = fetch_stree(stree_id, cache=cache,</span>
    <span class="c">##                    prune_to_ingroup=prune_to_ingroup)</span>
    <span class="c">## print &#39;  tree built&#39;</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">children</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">taxid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">n</span><span class="o">.</span><span class="n">taxids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c"># taxa represented by the node</span>
        <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># vertex in G</span>
        <span class="n">n</span><span class="o">.</span><span class="n">taxid_conflicts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c"># taxa in descendants that are not</span>
                                  <span class="c"># monophyletic</span>
        <span class="n">n</span><span class="o">.</span><span class="n">taxid_mrcas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c"># taxa whose mrca in the tree maps to the node</span>
        <span class="n">n</span><span class="o">.</span><span class="n">leaf_rootpath</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">n</span><span class="o">.</span><span class="n">nleaves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span><span class="o">.</span><span class="n">leaf_is_higher_taxon</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">n</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">lvs</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">leaves</span><span class="p">()</span>
    <span class="n">leafcounts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;!!! [</span><span class="si">%s</span><span class="s">] no taxid:&#39;</span> <span class="o">%</span> <span class="n">root</span><span class="o">.</span><span class="n">stree</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">snode_id</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">label</span>
            <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;!!! [</span><span class="si">%s</span><span class="s">] taxid not in taxonomy:&#39;</span> <span class="o">%</span> \
                  <span class="n">root</span><span class="o">.</span><span class="n">stree</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">snode_id</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">label</span>
            <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leafcounts</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lf</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">]</span>
            <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">v</span><span class="p">]</span>
            <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="o">=</span> <span class="n">taxid_rootpath</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lf</span><span class="o">.</span><span class="n">rootpath</span><span class="p">():</span> <span class="n">n</span><span class="o">.</span><span class="n">nleaves</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">multileaves</span> <span class="o">=</span> <span class="p">[</span> <span class="n">taxid</span> <span class="k">for</span> <span class="n">taxid</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">leafcounts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">]</span>
    <span class="n">root_mrca</span> <span class="o">=</span> <span class="n">rootpath_mrca</span><span class="p">([</span> <span class="n">x</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lvs</span>
                                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="p">])</span>
    <span class="n">root</span><span class="o">.</span><span class="n">taxid</span> <span class="o">=</span> <span class="n">root_mrca</span>
    <span class="k">print</span> <span class="s">&#39;root is&#39;</span><span class="p">,</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_name</span><span class="p">(</span><span class="n">root_mrca</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span>
        <span class="k">if</span> <span class="n">rp</span><span class="p">:</span> <span class="k">break</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">root_mrca</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">:</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">in</span> <span class="n">multileaves</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;!!! multiple taxid: </span><span class="si">%s</span><span class="s"> at lf </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">,</span> <span class="n">lf</span><span class="p">)</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>
                
    <span class="n">all_taxids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span> <span class="n">all_taxids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">taxid_rootpath</span><span class="p">)</span>
    <span class="n">subgraph</span> <span class="o">=</span> <span class="n">taxid_subgraph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">all_taxids</span><span class="p">)</span>
    <span class="n">all_taxids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">taxid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span>
            <span class="n">vtx</span> <span class="o">=</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">vtx</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="c"># higher taxon at leaf</span>
                <span class="k">print</span> <span class="s">&#39;!!! higher taxon </span><span class="si">%s</span><span class="s"> at lf </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">,</span> <span class="n">lf</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">leaf_is_higher_taxon</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">taxid_cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        taxids: if t1 is nested in t2, return t1 before t2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="o">==</span> <span class="n">t2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t2</span><span class="p">]</span>
        <span class="n">l1</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">hindex</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span>
        <span class="n">l2</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">hindex</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&gt;</span> <span class="n">l2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r1</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># t1 nested in t2</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&lt;</span> <span class="n">l2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r1</span> <span class="o">&gt;</span> <span class="n">r2</span><span class="p">):</span> <span class="k">return</span> <span class="mi">1</span> <span class="c"># t2 nested in t1</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>

    <span class="n">taxid_key</span> <span class="o">=</span> <span class="n">cmp_to_key</span><span class="p">(</span><span class="n">taxid_cmp</span><span class="p">)</span>
        
    <span class="n">conflicts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">con2mrca</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">taxid</span> <span class="ow">in</span> <span class="n">all_taxids</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        find the mrca node of each taxid in the tree, and determine if</span>
<span class="sd">        it is monophyletic, taking into account tips that are incertae</span>
<span class="sd">        sedis and/or unmapped</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nxt</span><span class="p">,</span> <span class="n">bck</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_hindex</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span> <span class="n">lf</span> <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span> <span class="k">if</span> <span class="n">taxid</span> <span class="ow">in</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid_rootpath</span> <span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">mrca</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">taxid_mrcas</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
        <span class="n">ismono</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">leaves</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">leaf_is_higher_taxon</span><span class="p">:</span>
                            <span class="c"># is taxid nested within lf.taxid?</span>
                            <span class="n">vnext</span><span class="p">,</span> <span class="n">vback</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_hindex</span><span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nxt</span> <span class="o">&gt;</span> <span class="n">vnext</span> <span class="ow">and</span> <span class="n">bck</span> <span class="o">&lt;</span> <span class="n">vback</span><span class="p">):</span> <span class="c"># no</span>
                                <span class="n">conflicts</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                                <span class="n">n</span><span class="o">.</span><span class="n">taxid_conflicts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
                                <span class="n">con2mrca</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                                <span class="n">ismono</span> <span class="o">=</span> <span class="bp">False</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">conflicts</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                            <span class="n">n</span><span class="o">.</span><span class="n">taxid_conflicts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
                            <span class="n">con2mrca</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                            <span class="n">ismono</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">break</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># is the parent taxon of lf.taxid an ancestor of taxid?</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span> <span class="c"># lf is mapped to root!</span>
                            <span class="k">continue</span>
                        <span class="n">ptax</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex_taxid</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">taxid_cmp</span><span class="p">(</span><span class="n">ptax</span><span class="p">,</span> <span class="n">taxid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># taxid is nested in ptax</span>
                            <span class="k">continue</span>
                        <span class="n">conflicts</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="n">n</span><span class="o">.</span><span class="n">taxid_conflicts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>
                        <span class="n">con2mrca</span><span class="p">[</span><span class="n">taxid</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                        <span class="n">ismono</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>
                    
        <span class="k">if</span> <span class="p">(</span><span class="n">ismono</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">taxids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">taxid_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">taxids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">lvs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
            <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">mrca</span> <span class="o">=</span> <span class="n">con2mrca</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">taxid</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lf</span><span class="o">.</span><span class="n">rootpath</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">mrca</span><span class="p">:</span> <span class="k">break</span>
                <span class="n">n</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">postiter</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxids</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
        <span class="k">elif</span> <span class="n">n</span><span class="o">.</span><span class="n">taxid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxid</span><span class="p">,)</span>
                <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxid</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
                <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">n</span><span class="o">.</span><span class="n">isleaf</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
            <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">taxid_mrcas</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">children</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">stem_cdef</span><span class="p">)</span>
            <span class="n">cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">stem_discard</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">crown_discard</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">taxid_cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">stem_discard</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                        <span class="n">crown_discard</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">stem_discard</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
                        <span class="n">crown_discard</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cdef</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stem_discard</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cdef</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">crown_discard</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span><span class="p">))</span>
        <span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">crown_cdef</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">postiter</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">parent</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span><span class="o">==</span><span class="n">n</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">stem_cdef</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>

    <span class="n">root</span><span class="o">.</span><span class="n">conflicts</span> <span class="o">=</span> <span class="n">conflicts</span>
    <span class="n">root</span><span class="o">.</span><span class="n">con2mrca</span> <span class="o">=</span> <span class="n">con2mrca</span>
    <span class="k">return</span> <span class="n">root</span>

</div>
<div class="viewcode-block" id="merge_stree"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.merge_stree">[docs]</a><span class="k">def</span> <span class="nf">merge_stree</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">stree</span><span class="p">,</span> <span class="n">verts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">verts</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">edges</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="c">## G.edge_strees = get_or_create_ep(G, &#39;stree&#39;, &#39;vector&lt;int&gt;&#39;)</span>
    <span class="c">## G.vertex_snode = get_or_create_ep(G, &#39;snode&#39;, &#39;int&#39;)</span>
    <span class="c">## G.vertex_strees = get_or_create_vp(G, &#39;stree&#39;, &#39;vector&lt;int&gt;&#39;)</span>
    <span class="c">## G.vertex_stem_cdef = get_or_create_vp(G, &#39;stem_cdef&#39;, &#39;vector&lt;int&gt;&#39;)</span>
    <span class="c">## G.stem_cdef_vertex = defaultdict(lambda: G.add_vertex())</span>
    <span class="c">## stree = root.rec.tree</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">taxids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span> <span class="c"># node represents 1+ taxa</span>
            <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">taxids</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">strees</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span> <span class="k">break</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">strees</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">p</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">or</span> <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="c">## if v == p:</span>
                <span class="c">##     print &#39;!! merge_stree&#39;, node.snode_id, v</span>
                <span class="c">##     loops.append((root, e))</span>
                <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">strees</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">edge_strees</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>
                <span class="c">## G.edge_stree[e] = stree</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">taxid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">taxid</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">strees</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">stem_cdef</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span> <span class="c"># node is a clade</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">stem_cdef_vertex</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">stem_cdef</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">G</span><span class="o">.</span><span class="n">vertex_stem_cdef</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">stem_cdef</span>
            <span class="n">strees</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">verts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">strees</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">v</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">taxids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">taxid_vertex</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">taxids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">or</span> <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;!! LOOP:&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">snode_id</span><span class="p">,</span> <span class="n">v</span>
                <span class="c">## loops.append((node, e))</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">strees</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">edge_strees</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strees</span><span class="p">:</span> <span class="n">strees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">leaves</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">incertae_sedis</span> <span class="ow">and</span> <span class="n">lf</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
            <span class="n">G</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">lf</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">label</span>

    <span class="k">return</span> <span class="n">verts</span><span class="p">,</span> <span class="n">edges</span>

</div>
<span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="c"># higher taxa that should be removed (nodes collapsed), and their</span>
    <span class="c"># immmediate children flagged incertae sedis and linked back to</span>
    <span class="c"># the parent of collapsed node</span>
    <span class="n">incertae_keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;endophyte&#39;</span><span class="p">,</span><span class="s">&#39;scgc&#39;</span><span class="p">,</span><span class="s">&#39;libraries&#39;</span><span class="p">,</span><span class="s">&#39;samples&#39;</span><span class="p">,</span><span class="s">&#39;metagenome&#39;</span><span class="p">,</span><span class="s">&#39;unclassified&#39;</span><span class="p">,</span>
        <span class="s">&#39;other&#39;</span><span class="p">,</span><span class="s">&#39;unidentified&#39;</span><span class="p">,</span><span class="s">&#39;mitosporic&#39;</span><span class="p">,</span><span class="s">&#39;uncultured&#39;</span><span class="p">,</span><span class="s">&#39;incertae&#39;</span><span class="p">,</span>
        <span class="s">&#39;environmental&#39;</span><span class="p">]</span>

    <span class="c"># taxa that are not clades, and should be removed (collapsed) -</span>
    <span class="c"># children linked to parent of collapsed node</span>
    <span class="n">collapse_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;basal &#39;</span><span class="p">,</span><span class="s">&#39;stem &#39;</span><span class="p">,</span><span class="s">&#39;early diverging &#39;</span><span class="p">]</span>

    <span class="c"># higher taxa that should be removed along with all of their children</span>
    <span class="n">remove_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;viroids&#39;</span><span class="p">,</span><span class="s">&#39;virus&#39;</span><span class="p">,</span><span class="s">&#39;viruses&#39;</span><span class="p">,</span><span class="s">&#39;viral&#39;</span><span class="p">,</span><span class="s">&#39;artificial&#39;</span><span class="p">]</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;removing vertices that are not real taxa (clades)&#39;</span><span class="p">)</span>
    <span class="n">rm</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">collapsed</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">rm</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">Traverser</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(),</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex_name</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">remove_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">gt</span><span class="o">.</span><span class="n">dfs_search</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">incertae_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">rm</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">out_neighbours</span><span class="p">():</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">incertae_sedis</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">break</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">collapse_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
                <span class="n">rm</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">break</span>

    <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># assume root == vertex 0</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="p">[</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span>
              <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outer</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">rm</span><span class="p">[</span><span class="n">p</span><span class="p">]:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">edge_in_taxonomy</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">print</span> <span class="s">&#39;done&#39;</span>

    <span class="n">g</span><span class="o">.</span><span class="n">set_vertex_filter</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">):</span> <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span>
    
<div class="viewcode-block" id="layout"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.layout">[docs]</a><span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rootv</span><span class="p">,</span> <span class="n">sfdp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">deg0</span><span class="o">=-</span><span class="mf">45.0</span><span class="p">,</span> <span class="n">degspan</span><span class="o">=</span><span class="mf">90.0</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">isouter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">([</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">out_neighbours</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">x</span> <span class="p">])</span>
    <span class="c">## isouter = lambda x: x.out_degree()==0</span>
    <span class="n">outer_vertices</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="k">if</span> <span class="n">isouter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">]</span>
    <span class="n">nouter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outer_vertices</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">deg0</span><span class="p">)]</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">degspan</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nouter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">iv2angle</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">outer_seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">iv2dist</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">all_seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&#39;vector&lt;float&gt;&#39;</span><span class="p">)</span>
    <span class="n">pin</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">pin</span><span class="p">[</span><span class="n">rootv</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="n">pos</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>

    <span class="n">wt</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&#39;float&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
        <span class="n">strees</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">edge_strees</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strees</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">wt</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">wt</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">outer_vertices</span><span class="p">:</span>
        <span class="n">pv</span><span class="p">,</span> <span class="n">pe</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">rootv</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">pe</span><span class="p">):</span>
            <span class="n">wt</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span>
    <span class="n">g</span><span class="o">.</span><span class="n">wt</span> <span class="o">=</span> <span class="n">wt</span>

    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">):</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">outer_vertices</span><span class="p">:</span>
            <span class="n">iv2dist</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">iv2dist</span><span class="p">[</span><span class="n">iv</span><span class="p">],</span> <span class="n">dist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iv</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outer_seen</span><span class="p">:</span>
                <span class="n">ang</span> <span class="o">=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">iv2angle</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">=</span> <span class="n">ang</span>
                <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">unit</span>
                <span class="n">rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">radius</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">radius</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
                <span class="n">pin</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">outer_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
        <span class="n">all_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">oe</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">out_edges</span><span class="p">():</span>
            <span class="n">ov</span> <span class="o">=</span> <span class="n">oe</span><span class="o">.</span><span class="n">target</span><span class="p">()</span>
            <span class="c">## if len(G.edge_strees[oe])&gt;0 and (int(ov) not in all_seen):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ov</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_seen</span><span class="p">:</span>
                <span class="n">traverse</span><span class="p">(</span><span class="n">ov</span><span class="p">,</span> <span class="n">dist</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
    <span class="n">traverse</span><span class="p">(</span><span class="n">rootv</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sfdp</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">sfdp_layout</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="n">pin</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="c"># theta=2,</span>
                             <span class="n">K</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                             <span class="n">eweight</span><span class="o">=</span><span class="n">wt</span><span class="p">,</span>
                             <span class="n">mu</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">multilevel</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">pin</span>

</div>
<div class="viewcode-block" id="articulation_bfs"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.articulation_bfs">[docs]</a><span class="k">def</span> <span class="nf">articulation_bfs</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">arts</span><span class="p">):</span>
    <span class="n">isouter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="p">[</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">out_neighbours</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">x</span> <span class="p">]</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
    <span class="n">leaves</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">out_neighbours</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">isouter</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">arts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span>
                              <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertex_strees</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">leaves</span><span class="p">:</span> <span class="n">leaves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="n">traverse</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">traverse</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leaves</span> <span class="p">]</span>
</div>
<div class="viewcode-block" id="bicomp_tree"><a class="viewcode-back" href="../../ivy.html#ivy.treegraph_experimental.bicomp_tree">[docs]</a><span class="k">def</span> <span class="nf">bicomp_tree</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">rootv</span><span class="p">,</span> <span class="n">arts</span><span class="p">,</span> <span class="n">traversed</span><span class="p">):</span>
    <span class="s">&quot;generate tree of biconnected components of DAG&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
    <span class="n">leaf_verts</span> <span class="o">=</span> <span class="n">articulation_bfs</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">rootv</span><span class="p">,</span> <span class="n">arts</span><span class="p">)</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">leaf_verts</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">traversed</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">rootv</span> <span class="p">]</span>
    <span class="n">traversed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">rootv</span>
    <span class="n">r</span><span class="o">.</span><span class="n">leaf_verts</span> <span class="o">=</span> <span class="n">leaf_verts</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">leaf_verts</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">isleaf</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">print</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">leaf_verts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">verts</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">bicomp_tree2</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">arts</span><span class="p">,</span> <span class="n">traversed</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ivy 0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, RR, CZ.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>